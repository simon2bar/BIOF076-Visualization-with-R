---
title: "Using Maps in R"
author: "Vinay Swamy"
date: "9/16/2020"
output: ioslides_presentation
---

## Plotting Maps in R
- R was well known in its early years for having good libraries for making plots with maps.
- While not too common in biological sciences, map based plots are common in fields like public health and ecology
- The libraries for making maps are notoriously difficult to install, especially on a Mac. We'll go through how to install its later, but it will probably be easier if you use the `binder` link in the repo

## the `sf` package
- `sf` stands for "simple features", and is a way for representing the physical diagram of a map as a dataframe. This format is not unique to R, and is used by many different programs 
- `sf` is the successor to the `sp` package, which was what gave maps in R its fame 

- This is some example data provided in the `sf` pakage. It contains geospatial information about the state of North Carolina. you can recognize geospatial data by the `.shp` extension. the `st_read` function allows you to read `.shp` data into R. Within R, it exists as a custom class, also called `sf
```{r}
library(sf)
nc <- st_read(system.file("shape/nc.shp", package="sf"))
nc
str(nc)
```
- the most important part of an `sf` object is the `geometry` column; this contains the actual information about how to draw each map

- `sf` objects can be easily coerced to a tibble

```{r}
nc_table <- nc %>% as_tibble
nc_table
```



-`sf` was designed to be used with base R's plotting interface

```{r, message=F, warning=FALSE}
plot(nc)
```

- but since plotting in base R isn't great, we'll be combining `sf` with another package, `ggspatial`. 
- when using `geom_sf`, we can directly pass `sf` objects. When doing this, aesthetic mappings are automatically generated

```{r}
library(tidyverse)
library(ggplot)
library(ggspatial)
ggplot(data = nc ) +
    geom_sf() + 
    theme_bw()

```

- when using using a `tibble` as input, manually specify the aesthetic mapping

```{r}
ggplot(nc_table) + 
    geom_sf(aes( geometry= geometry)) + 
    theme_bw()
```

- from here, we can treat the plot like a normal `ggplot, changing aesthetics as we please

```{r}
ggplot(nc_table) + 
    geom_sf(aes( geometry= geometry, fill = SID74)) + 
    theme_bw()
```

## Using Maps with real data 
- Almost always, real data does not come with geometry coordinates attached. if you're lucky, you'll get tabular data that has some kind of easy geographical identifier, like state, country, or zip code.


- Heres an (slightly morbid) example - Violent Crime Arrests in the US
```{r}
data("USArrests")
USArrests
```

- the general workflow for plotting maps is taking an `sf` object that has defined geomtry, and then connecting the `sf` data to our tablular data.

- there are multiple packages for obtaining map data, but its often not in `sf` format. luckily, the `sf` package provides the function `st_as_sf` to convert other formats to `sf` format

```{r}
library(maps)
library(sf)

states <- maps::map("state", plot = FALSE, fill = TRUE) %>% st_as_sf() %>% 
    as_tibble %>% 
    rename(state = ID, 
           geometry = geom)


states
```


```{r}
arrests <- USArrests %>% rownames_to_column('state')
arrests
```


```{r}
inner_join(arrests, states)
```

- What happened?



## always check your joins!
- in this case the cases in the `state` column doesnt match 

```{r}
states <- states %>% 
    mutate(state = tolower(state))

arrestData_with_mapData <- arrests %>%
    mutate(state = tolower(state)) %>% 
    inner_join( states)
ggplot(arrestData_with_mapData) + 
    geom_sf(aes(geometry = geometry, fill = Assault)) + 
    theme_bw()


```

-lets pretty it up a little

```{r}

ggplot(arrestData_with_mapData) + 
    geom_sf(aes(geometry = geometry, fill = Assault)) + 
    scale_fill_viridis_c('Hundreds of Persons') + 
    ggtitle('Number of Assaults per state')+
    theme_void()

```

# using coordinate systems 
- sometimes you don't even get a region, and just get lattitudes, and longitudes

- this is some example data about the locations of earthquakes in fiji 
```{r}
data("quakes")
quakes
```

```{r}
library(rnaturalearth)
library(rnaturalearthdata)
world <- ne_countries(scale = "medium", returnclass = "sf")

quakes_sf <- quakes %>% st_as_sf(coords = c("long", "lat"),crs = 3460 ) %>% as_tibble 
ggplot() +
    geom_sf(data = quakes_sf,  aes(geometry = geometry), alpha = .1)+
    geom_sf(data = world, color = 'red') +
    coord_sf( ylim = c(-50, -10),  xlim = c(165, 200)) + 
    theme_bw()

```

```{r}


```


```{r}
library(ggplot2)
library(tidyverse)
library(gganimate)
library(sf)

covid_cases_by_zipcode <- read_tsv('day_2/MD_COVID_cases_by_zip.tsv.gz') %>% rename(zip_code = ZIP_CODE)
covid_cases_by_zipcode[is.na(covid_cases_by_zipcode)] <- 0
zip_to_county <- read_tsv('day_2/maryland_zipcode_to_county.tsv.gz') %>% mutate(county = tolower(county))
covid_cases_zip_county <- inner_join(zip_to_county, covid_cases_by_zipcode) 
maryland_physical_boundaries <- st_read('~/Downloads/Maryland_Physical_Boundaries_-_County_Boundaries__Generalized_-shp/Maryland_Physical_Boundaries_-_County_Boundaries__Generalized_.shp') %>% as_tibble %>% 
    mutate(county = tolower(county))

sum(maryland_physical_boundaries$county %in% covid_cases_zip_county$county)
covid_by_county <- covid_cases_zip_county %>% 
    pivot_longer(-c(zip_code, county, OBJECTID), names_to = 'date', values_to = 'covid_cases' ) %>% 
    group_by(county, date) %>% 
    summarise(total_cases = sum(covid_cases)) %>% 
    left_join(maryland_physical_boundaries) 

fc <-  filter (covid_by_county, date == '05_21_2020') 
covid_by_county <- covid_by_county %>% 
    mutate(date = lubridate::parse_date_time(date ,'mdy') %>% as.Date())
test <- covid_by_county %>% filter(date %in% unique(date)[1:2]) %>% arrange(date)
test$date <- as.numeric(c(rep(2018, 24),rep(2020, 24) ))
ggplot(test) + 
    geom_sf(aes(geometry = geometry, ) ) + 
    #scale_fill_viridis_c('Total Covid Cases', na.value = 'grey')+
    transition_states(date, 1, 1)

ttab <- rbind(nc_table, nc_table %>% mutate(BIR74 = rnorm(100, 10))) %>% 
    mutate(year = c(rep('2018_05_10', 100), rep('2020_06_10', 100)) %>% lubridate::parse_date_time('ymd'))
ggplot(ttab) + 
    geom_sf(aes(geometry = geometry, fill = BIR74))  +
    #scale_fill_viridis_c('Total Covid Cases', na.value = 'grey')+
    transition_states(year)

```



```{r}
library(gapminder)

ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
  transition_time(year) +
  ease_aes('linear')
```


